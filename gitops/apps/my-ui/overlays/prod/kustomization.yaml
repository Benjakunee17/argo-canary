apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# namespace ‡∏Ç‡∏≠‡∏á production
namespace: my-ui-prod

resources:
  - ../../base

# ‡πÉ‡∏™‡πà label ‡πÉ‡∏´‡πâ resource ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô prod
labels:
  - pairs:
      env: prod

# ‡∏ï‡∏≠‡∏ô promote ‡πÅ‡∏Ñ‡πà‡πÅ‡∏Å‡πâ newTag ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
images:
  - name: ghcr.io/benjakunee17/my-ui
    newName: ghcr.io/benjakunee17/my-ui
    newTag: 41e84c7  # üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô promote

patches:
  # -----------------------------
  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô host ‡πÄ‡∏õ‡πá‡∏ô domain prod ‡∏à‡∏£‡∏¥‡∏á
  # -----------------------------
  - target:
      kind: Ingress
      name: my-ui
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: my-ui.company.com

  # -----------------------------
  # ‡πÄ‡∏û‡∏¥‡πà‡∏° replicas ‡πÉ‡∏´‡πâ prod
  # -----------------------------
  - target:
      kind: Rollout
      name: my-ui
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 6

  # -----------------------------
  # ‡∏ó‡∏≥ Canary ‡πÅ‡∏ö‡∏ö Production
  # - slow
  # - manual promote
  # - analysis metric
  # -----------------------------
  - target:
      kind: Rollout
      name: my-ui
    patch: |-
      - op: replace
        path: /spec/strategy/canary/steps
        value:
          - setWeight: 5
          - pause: {}     # manual approve
          - analysis:
              templates:
                - templateName: success-rate

          - setWeight: 20
          - pause: {}     # manual approve
          - analysis:
              templates:
                - templateName: success-rate

          - setWeight: 50
          - pause: {}     # manual approve
          - analysis:
              templates:
                - templateName: success-rate

          - setWeight: 100

  # -----------------------------
  # ‡πÄ‡∏õ‡∏¥‡∏î NGINX traffic routing ‡πÉ‡∏´‡πâ Rollouts
  # - ‡πÉ‡∏´‡πâ setWeight ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏±‡∏ö ingress (stableIngress)
  # - ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤ analysis fail ‚Üí abort ‡πÅ‡∏•‡πâ‡∏ß traffic ‡∏à‡∏∞‡∏Ñ‡∏á‡∏ó‡∏µ‡πà stable
  # -----------------------------
  - target:
      kind: Rollout
      name: my-ui
    patch: |-
      - op: add
        path: /spec/strategy/canary/trafficRouting
        value:
          nginx:
            stableIngress: my-ui

      - op: add
        path: /spec/strategy/canary/abortScaleDownDelaySeconds
        value: 0

  # -----------------------------
  # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö pod template label ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô prod
  # (base ‡∏°‡∏µ env: dev ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ replace)
  # -----------------------------
  - target:
      kind: Rollout
      name: my-ui
    patch: |-
      - op: replace
        path: /spec/template/metadata/labels/env
        value: prod